<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Automation Ascendancy Framework</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .step-item.active .step-circle {
            background-color: #9333ea;
            color: white;
            border-color: #9333ea;
        }
        .step-item.active .step-text {
             color: #9333ea;
             font-weight: 600;
        }
         .step-item.completed .step-circle {
            background-color: #a78bfa; /* lighter purple */
            color: white;
            border-color: #a78bfa;
        }
        .step-item.completed .step-text {
            color: #5b21b6;
        }
        .step-item.completed {
            cursor: pointer;
        }

        .pillar-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .pillar-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .level-item::before {
            content: '';
            position: absolute;
            left: 1.25rem;
            top: 2.5rem;
            bottom: -2.5rem;
            width: 2px;
            background-color: #d1d5db;
            transform: translateX(-50%);
        }
        .level-item:last-child::before {
            display: none;
        }
        .level-circle {
            z-index: 10;
        }
        /* Custom range input style */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #9333ea;
            cursor: pointer;
            border-radius: 50%;
            margin-top: -8px;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #9333ea;
            cursor: pointer;
            border-radius: 50%;
        }
        details > summary {
            cursor: pointer;
        }
        /* Styles for PDF export content */
        @media print {
            body * {
                visibility: hidden;
            }
            #pdf-content, #pdf-content * {
                visibility: visible;
            }
            #pdf-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body class="antialiased text-slate-700">
    <div class="min-h-screen px-4 sm:px-6 lg:px-8">
        <header class="text-center py-10 flex flex-col items-center">
            <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-indigo-600">Strategic Automation Ascendancy Framework</h1>
            <p class="mt-2 text-lg font-medium text-slate-500">Powered by Accenture SRE Capability Team</p>
        </header>

        <main class="bg-white rounded-2xl shadow-xl p-6 sm:p-8 mb-8">
            <!-- Step Navigation -->
            <div id="step-nav-container" class="border-b border-gray-200 pb-5 mb-8">
                <div id="step-indicator" class="flex items-center justify-between">
                    <!-- Step indicator will be populated by JS -->
                </div>
            </div>
            
            <div id="nav-buttons-container" class="flex justify-end mb-4">
                 <div class="flex gap-4">
                    <button id="back-button" class="bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Back</button>
                    <button id="next-button" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700 transition-colors shadow-md">Next</button>
                </div>
            </div>


            <!-- Tab Content -->
            <div id="tab-content">
                <!-- Home Screen -->
                <div id="home" class="tab-pane">
                    <div class="text-center py-16">
                        <h2 class="text-3xl font-bold text-slate-800 mb-8">Automation Maturity Assessment Survey</h2>
                        <button id="begin-survey-button" class="bg-purple-600 text-white font-bold py-4 px-8 rounded-lg hover:bg-purple-700 transition-colors shadow-lg text-lg">Begin Survey</button>
                    </div>
                </div>

                <!-- Executive Summary -->
                <div id="summary" class="tab-pane hidden">
                    <h2 class="text-2xl font-semibold text-slate-800 mb-4">Executive Summary</h2>
                    <div class="space-y-4 text-slate-600 leading-relaxed">
                        <p>The Strategic Automation Ascendancy Framework is a comprehensive model designed to guide our organization's evolution from manual, reactive IT operations to a proactive, autonomous, and AI-driven state. By blending the aspirational goals of an agentic future with the concrete, measurable criteria from our current Automation Maturity Assessment, this framework provides a clear, actionable roadmap.</p>
                        <p>It is built on <strong>eight core pillars</strong> of operational excellence, each with a <strong>strategic weight</strong> reflecting its impact on business resilience, efficiency, and innovation. Our progress through <strong>five distinct maturity levels</strong> will be measured against these pillars, providing a unified score that allows us to track our transformation, prioritize investments, and align technical efforts with strategic business outcomes. This document serves as a guide for both executive leaders seeking to understand the "why" and "what" of this journey and for architects designing the "how."</p>
                    </div>
                     <!-- Matrix will be injected here by JS -->
                </div>
                
                 <!-- Responder Details -->
                <div id="responder-details" class="tab-pane hidden">
                    <h2 class="text-2xl font-semibold text-slate-800 mb-6">Responder Details</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 bg-slate-50 p-8 rounded-lg border border-slate-200">
                        <div>
                            <label for="engagement-name" class="block text-sm font-medium text-gray-700">Engagement Name</label>
                            <input type="text" id="engagement-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="project-team" class="block text-sm font-medium text-gray-700">Project Team</label>
                            <input type="text" id="project-team" value="SRE" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="delivery-lead" class="block text-sm font-medium text-gray-700">Delivery Lead</label>
                            <input type="text" id="delivery-lead" value="Juan Dela Cruz" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="sdm" class="block text-sm font-medium text-gray-700">Service Delivery Manager</label>
                            <input type="text" id="sdm" value="Juan Dela Cruz" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="engagement-md" class="block text-sm font-medium text-gray-700">Engagement MD</label>
                            <input type="text" id="engagement-md" value="Juan Dela Cruz" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="assessment-date" class="block text-sm font-medium text-gray-700">Date of Assessment</label>
                            <input type="date" id="assessment-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm">
                        </div>
                    </div>
                </div>


                <!-- Core Pillars -->
                <div id="pillars" class="tab-pane hidden">
                     <h2 class="text-2xl font-semibold text-slate-800 mb-2">The Eight Core Pillars of Automation</h2>
                     <p class="text-slate-600 mb-8">These represent the foundational areas we must master to achieve operational excellence.</p>
                     <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                        <!-- Pillar Data will be injected here by JS -->
                     </div>
                </div>

                <!-- Maturity Levels -->
                <div id="levels" class="tab-pane hidden">
                    <h2 class="text-2xl font-semibold text-slate-800 mb-2">The Five Maturity Levels</h2>
                    <p class="text-slate-600 mb-8">The journey from a manual, reactive state to a fully autonomous, agent-driven one, aligned with our service assessment criteria.</p>
                    <div class="relative pl-12">
                         <!-- Levels Data will be injected here by JS -->
                    </div>
                </div>
                
                <!-- Tower Selection -->
                <div id="selection" class="tab-pane hidden">
                    <h2 class="text-2xl font-semibold text-slate-800 mb-2">Select Towers for Assessment</h2>
                    <p class="text-slate-600 mb-6">Choose the service towers you want to include in this assessment session. Your selections will be available in the 'Maturity Assessment' and 'Maturity Report' tabs.</p>
                    <div class="border-t border-b border-gray-200 py-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium">Available Towers</h3>
                            <div class="space-x-4">
                                <button id="select-all-towers" class="text-sm font-medium text-purple-600 hover:text-purple-800">Select All</button>
                                <button id="deselect-all-towers" class="text-sm font-medium text-purple-600 hover:text-purple-800">Deselect All</button>
                            </div>
                        </div>
                        <div id="tower-selection-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                            <!-- Checkboxes will be populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Maturity Calculator -->
                <div id="calculator" class="tab-pane hidden">
                     <div class="flex flex-col lg:flex-row gap-8">
                        <!-- Left Side: Detailed Assessment -->
                        <div class="lg:w-2/3">
                            <h2 class="text-2xl font-semibold text-slate-800 mb-2">Detailed Catalog Group Assessment</h2>
                            <p class="text-slate-600 mb-6">Select a tower from the list below to assess its catalog groups.</p>
                            
                            <div id="tower-assessment-list-container" class="mb-6 pb-4 border-b">
                                <!-- Tower tabs will be populated here -->
                            </div>

                            <div id="assessment-questions" class="space-y-4">
                                <!-- Assessment questions will be injected here -->
                            </div>
                        </div>
                        <!-- Right Side: Summary Score -->
                        <div class="lg:w-1/3">
                             <h2 class="text-2xl font-semibold text-slate-800 mb-2">Pillar Score Summary</h2>
                            <p class="text-slate-600 mb-6">Pillar scores for the selected tower.</p>
                            <div class="bg-slate-50 rounded-lg p-6 sticky top-8">
                                <div id="summary-sliders" class="space-y-4 mb-6">
                                    <!-- Sliders will be generated here -->
                                </div>
                                <div class="text-center">
                                    <h3 class="text-lg font-medium text-slate-600">Overall Maturity Score</h3>
                                    <p id="total-score" class="text-6xl font-bold text-purple-600 my-2">0.00</p>
                                    <p id="maturity-level-display" class="inline-block text-xl font-semibold text-slate-800 bg-slate-200 rounded-full px-5 py-1">Core</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Maturity Report -->
                <div id="assessment" class="tab-pane hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-semibold text-slate-800">Maturity Report</h2>
                            <p class="text-slate-600">This dashboard summarizes the assessment results for all selected towers.</p>
                        </div>
                        <button id="export-pdf-button" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors shadow-md flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            Export Results to PDF
                        </button>
                    </div>
                    
                     <div id="dashboard-summary" class="mb-8 p-6 bg-purple-50 border border-purple-200 rounded-lg text-center">
                        <h3 class="text-lg font-medium text-slate-600">Overall Maturity Score (All Selected Towers)</h3>
                        <p id="overall-dashboard-score" class="text-6xl font-bold text-purple-600 my-2">0.00</p>
                        <p id="overall-dashboard-level" class="inline-block text-xl font-semibold bg-purple-200 text-purple-800 rounded-full px-5 py-1">Core</p>
                    </div>

                    <div id="dashboard-results-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Tower result cards will be injected here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Incomplete Assessment Modal -->
    <div id="incomplete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center p-4">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Assessment Incomplete</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        Please review the following towers to ensure your assessment is complete and accurate before submitting:
                    </p>
                    <ul id="pending-towers-list" class="text-sm text-gray-700 font-medium list-disc list-inside mt-2 text-left">
                        <!-- Pending towers will be listed here -->
                    </ul>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-incomplete-modal-button" class="px-4 py-2 bg-purple-600 text-white text-base font-medium rounded-md w-full hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full hidden z-50 flex items-center justify-center p-4">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                    <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Confirm Submission</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        Please confirm that your responses are accurate to the best of your knowledge.
                        <br><br>
                        Upon submission, a raw data export will be downloaded, and your email client will open.
                        <br><br>
                        <strong class="text-gray-700">Remember to attach the downloaded Excel file before sending.</strong>
                    </p>
                </div>
                <div class="items-center px-4 py-3 gap-2 flex justify-center">
                    <button id="cancel-submission-button" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-24 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        Cancel
                    </button>
                    <button id="confirm-submission-button" class="px-4 py-2 bg-purple-600 text-white text-base font-medium rounded-md w-auto hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        Confirm & Proceed
                    </button>
                </div>
            </div>
        </div>
    </div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const pillarsData = [
            { id: "fin-man", name: "Financial Management", weight: 10, definition: "A framework that brings together technology, finance, and business teams to drive financial accountability. It maximizes the value derived from investments through collaboration, data-driven decision-making, and shared responsibility for incurred costs." },
            { id: "sec-pos", name: "Security Posture Management", weight: 20, definition: "Cybersecurity technology that automates and unifies the identification and remediation of misconfigurations and vulnerabilities across hybrid and multi-cloud environments. It provides a single view of the security posture to reduce risk." },
            { id: "mod-proc", name: "Modern Processes", weight: 5, definition: "A disciplined, data-driven approach to integrating software development (Dev) and IT operations (Ops). It automates and optimizes processes through tools like Agile, SRE, and Platform Engineering to build, test, and release software faster and more reliably." },
            { id: "defect-dens", name: "Reduce Defect Density", weight: 10, definition: "The process of identifying, analyzing, and resolving the underlying causes of incidents to prevent their recurrence. It aims to minimize business impact by moving from a reactive to a proactive approach to issue management." },
            { id: "self-heal", name: "Self Heal / Auto Resolution", weight: 20, definition: "Creating a resilient system that can automatically detect, diagnose, and recover from failures without manual intervention. This includes automated event correlation, runbooks, and self-healing scripts to maintain service availability." },
            { id: "change-rel", name: "Change/Release/Patching", weight: 10, definition: "The automation of implementing changes to streamline processes, reduce errors, improve speed, and enhance security. This includes predicting change risk, analyzing release impact, and deploying patches through automated workflows." },
            { id: "devops", name: "DevOps Pipelines", weight: 10, definition: "An automated process for developers to reliably and efficiently get their code from version control into production. It encompasses build, test, and deployment stages (CI/CD) with integrated quality and security gates." },
            { id: "obs-ai", name: "Observability & AI Insights", weight: 15, definition: "The practice of equipping systems with the tooling to debug in production. It goes beyond monitoring by collecting high-granularity data (logs, metrics, traces) and using AIOps to provide deep, actionable insights and predictive analysis." },
        ];
        
        const allTowers = [
            "Cloud Ops", "Windows Systems", "Linux Systems", "Hypervisors", "AIX Systems", 
            "Storage Systems", "Backup Systems", "Database Systems", "Middleware Systems", 
            "Batch Ops", "Monitoring & Tools", "Workplace Services", "Service Management", 
            "Network Services", "Service Desk"
        ];

        const towerCatalogData = {
            "Cloud Ops": {
                groups: [
                    { name: "Compute & App Services", description: "Management of VMs, containers (AKS), and application services.", mappedPillars: ["self-heal", "change-rel", "devops"] },
                    { name: "Storage & Data", description: "Provisioning and management of storage accounts, disks, and databases.", mappedPillars: ["self-heal", "fin-man"] },
                    { name: "Networking", description: "Configuration of VNETs, subnets, load balancers, and DNS.", mappedPillars: ["sec-pos", "change-rel"] },
                    { name: "Security & Identity", description: "Management of security policies, key vaults, and access control.", mappedPillars: ["sec-pos", "mod-proc"] },
                    { name: "Monitoring & Governance", description: "Alerting, logging, cost management, and compliance.", mappedPillars: ["obs-ai", "fin-man", "defect-dens"] }
                ]
            },
            "Windows Systems": {
                groups: [
                    { name: "OS & Provisioning", description: "OS installation, upgrades, feature/role configuration, and server builds.", mappedPillars: ["change-rel", "devops"] },
                    { name: "Patch & Vulnerability Management", description: "WSUS patch management, vulnerability remediation, and compliance reporting.", mappedPillars: ["sec-pos", "change-rel"] },
                    { name: "Active Directory & GPO", description: "Management of users, groups, GPOs, and domain controller health.", mappedPillars: ["sec-pos", "mod-proc"] },
                    { name: "Performance & Health", description: "Monitoring server performance, health checks, and resolving performance-based alerts.", mappedPillars: ["obs-ai", "self-heal", "defect-dens"] },
                    { name: "Storage & Backup", description: "Managing disk space, datastores, and ensuring backup success from an OS perspective.", mappedPillars: ["self-heal"] }
                ]
            },
            "Linux Systems": {
                groups: [
                    { name: "OS & Provisioning", description: "Server builds, OS hardening, and configuration management.", mappedPillars: ["change-rel", "devops", "sec-pos"] },
                    { name: "Patch & Security Management", description: "Applying patches, vulnerability scanning, and managing security agents.", mappedPillars: ["sec-pos", "change-rel"] },
                    { name: "Performance & Health", description: "Monitoring system resources, log analysis, and automated health checks.", mappedPillars: ["obs-ai", "self-heal", "defect-dens"] },
                    { name: "Identity & Access", description: "User account management, sudo access, and directory integration.", mappedPillars: ["sec-pos", "mod-proc"] }
                ]
            },
            "Hypervisors": {
                groups: [
                    { name: "Host & Cluster Management", description: "ESXi/Hyper-V installation, patching, and cluster configuration (HA/DRS).", mappedPillars: ["change-rel", "self-heal"] },
                    { name: "VM Lifecycle Management", description: "VM provisioning, decommissioning, snapshots, and template management.", mappedPillars: ["devops", "change-rel"] },
                    { name: "Storage & Networking", description: "Datastore management (vSAN/NFS/FC), virtual switching, and port group configuration.", mappedPillars: ["self-heal", "sec-pos"] },
                    { name: "Health & Performance", description: "Monitoring host/VM performance, capacity planning, and alert remediation.", mappedPillars: ["obs-ai", "fin-man", "defect-dens"] }
                ]
            },
             "AIX Systems": {
                groups: [
                    { name: "LPAR & VIO Management", description: "Managing Logical Partitions, Virtual I/O Servers, and HMC operations.", mappedPillars: ["change-rel", "self-heal"] },
                    { name: "OS & Patch Management", description: "AIX upgrades, Technology Level (TL) and Service Pack (SP) application.", mappedPillars: ["change-rel", "sec-pos"] },
                    { name: "High Availability & Clustering", description: "PowerHA (HACMP) configuration, testing, and failover management.", mappedPillars: ["self-heal", "defect-dens"] },
                    { name: "Performance & Troubleshooting", description: "Performance tuning, log analysis, and resolving system-level issues.", mappedPillars: ["obs-ai", "defect-dens"] }
                ]
            },
             "Storage Systems": {
                groups: [
                    { name: "SAN/NAS Provisioning", description: "LUN creation, masking, volume/share creation, and managing quotas.", mappedPillars: ["change-rel", "fin-man"] },
                    { name: "Replication & Data Protection", description: "Managing snapshots, clones, and remote replication for disaster recovery.", mappedPillars: ["self-heal", "sec-pos"] },
                    { name: "Performance & Capacity Management", description: "Monitoring array performance, analyzing trends, and planning for capacity.", mappedPillars: ["obs-ai", "fin-man", "defect-dens"] },
                    { name: "Fabric & Connectivity", description: "SAN switch zoning, path management, and ensuring host connectivity.", mappedPillars: ["change-rel", "self-heal"] }
                ]
            },
            "Backup Systems": {
                groups: [
                    { name: "Backup Policy & Scheduling", description: "Configuring backup jobs, retention policies, and scheduling.", mappedPillars: ["mod-proc", "change-rel"] },
                    { name: "Restore & Recovery Operations", description: "Performing data restores, recovery drills, and validation.", mappedPillars: ["self-heal", "defect-dens"] },
                    { name: "Infrastructure Health & Maintenance", description: "Monitoring backup servers, tape libraries, and storage targets; applying patches.", mappedPillars: ["obs-ai", "sec-pos"] },
                    { name: "Reporting & Compliance", description: "Generating reports on backup success/failure, capacity, and compliance.", mappedPillars: ["obs-ai", "fin-man"] }
                ]
            },
             "Database Systems": {
                groups: [
                    { name: "Monitoring, Reporting & Administration", description: "Daily checks, performance reporting, security parameter management, and audit compliance.", mappedPillars: ["obs-ai", "sec-pos", "mod-proc"] },
                    { name: "Structural Maintenance", description: "Capacity planning, object management (tables, indexes), and physical layout.", mappedPillars: ["self-heal", "fin-man"] },
                    { name: "Patch Management", description: "Identifying, testing, and deploying database patches.", mappedPillars: ["change-rel", "sec-pos"] },
                    { name: "Backup & Recovery", description: "Managing database backups, restores, and performing disaster recovery drills.", mappedPillars: ["self-heal", "defect-dens"] },
                    { name: "Engineering & Performance Tuning", description: "Advanced troubleshooting, query optimization, and resolving systemic issues.", mappedPillars: ["defect-dens", "obs-ai"] }
                ]
            },
            "Middleware Systems": {
                 groups: [
                    { name: "App Server Management", description: "Installation, configuration, and patching of application servers (e.g., Tomcat, JBoss).", mappedPillars: ["change-rel", "devops"] },
                    { name: "Messaging & Integration", description: "Managing message queues (MQ), brokers, and integration platforms.", mappedPillars: ["self-heal", "defect-dens"] },
                    { name: "Deployment & Configuration", description: "Automating application deployments (WAR/EAR files) and configuration changes.", mappedPillars: ["devops", "change-rel"] },
                    { name: "Health & Performance Monitoring", description: "Monitoring heap size, thread pools, and application performance.", mappedPillars: ["obs-ai", "self-heal"] }
                ]
            },
            "Batch Ops": {
                groups: [
                    { name: "Job Scheduling & Management", description: "Creating, modifying, and managing job definitions and schedules.", mappedPillars: ["mod-proc", "change-rel"] },
                    { name: "Execution Monitoring", description: "Monitoring job execution, identifying failures, and managing alerts.", mappedPillars: ["obs-ai", "defect-dens"] },
                    { name: "Error Handling & Reruns", description: "Automating the process for handling failed jobs and executing reruns.", mappedPillars: ["self-heal"] },
                    { name: "Dependency & Flow Control", description: "Managing complex job chains, dependencies, and calendars.", mappedPillars: ["mod-proc"] }
                ]
            },
            "Monitoring & Tools": {
                 groups: [
                    { name: "Alerting & Configuration", description: "Creating, tuning, and managing monitoring alerts and thresholds.", mappedPillars: ["obs-ai", "defect-dens"] },
                    { name: "Agent Management", description: "Deploying, upgrading, and maintaining monitoring agents across the estate.", mappedPillars: ["devops", "change-rel"] },
                    { name: "Dashboarding & Reporting", description: "Creating and maintaining dashboards and generating performance reports.", mappedPillars: ["obs-ai", "fin-man"] },
                    { name: "Platform Health & Maintenance", description: "Ensuring the monitoring platform itself is healthy, patched, and performing optimally.", mappedPillars: ["self-heal", "sec-pos"] }
                ]
            },
            "Workplace Services": {
                 groups: [
                    { name: "Endpoint Management", description: "OS imaging, patching, policy enforcement (GPO/Intune), and device compliance.", mappedPillars: ["sec-pos", "change-rel"] },
                    { name: "Application Delivery", description: "Software packaging, deployment, and lifecycle management (e.g., via SCCM).", mappedPillars: ["devops", "change-rel"] },
                    { name: "Collaboration Services", description: "Managing email (Exchange), SharePoint, OneDrive, and Teams.", mappedPillars: ["self-heal", "mod-proc"] },
                    { name: "User Support & Onboarding", description: "Automating common user requests, account creation, and access provisioning.", mappedPillars: ["self-heal", "defect-dens"] }
                ]
            },
            "Service Management": {
                 groups: [
                    { name: "Incident & Problem Management", description: "Automating ticket creation, routing, categorization, and root cause analysis.", mappedPillars: ["defect-dens", "self-heal"] },
                    { name: "Change & Release Management", description: "Automating change approvals, scheduling, and post-implementation reviews.", mappedPillars: ["change-rel", "mod-proc"] },
                    { name: "Service Request Fulfillment", description: "Automating fulfillment of common requests from the service catalog.", mappedPillars: ["self-heal", "devops"] },
                    { name: "CMDB & Asset Management", description: "Automating discovery, reconciliation, and maintenance of Configuration Items (CIs).", mappedPillars: ["obs-ai", "sec-pos"] }
                ]
            },
            "Network Services": {
                groups: [
                    { name: "LAN/WAN Operations", description: "Troubleshooting and changes for Local and Wide Area Networks.", mappedPillars: ["self-heal", "defect-dens"] },
                    { name: "Network Services (DNS/DHCP/LB)", description: "Management of DNS records, DHCP scopes, and Load Balancer configurations.", mappedPillars: ["change-rel", "self-heal"] },
                    { name: "Voice & Collaboration", description: "Managing VoIP infrastructure, user profiles (Jabber/Webex), and collaboration devices.", mappedPillars: ["change-rel", "mod-proc"] },
                    { name: "Security & Compliance", description: "Firewall rule management, device compliance audits, and certificate renewals.", mappedPillars: ["sec-pos", "change-rel"] },
                    { name: "Monitoring & Reporting", description: "Monitoring network alerts and preparing performance/incident reports.", mappedPillars: ["obs-ai"] }
                ]
            },
            "Service Desk": {
                 groups: [
                    { name: "Incident Triage & Resolution", description: "Automated first-level troubleshooting, diagnostics, and resolution of common incidents.", mappedPillars: ["self-heal", "defect-dens"] },
                    { name: "User Request Fulfillment", description: "Automating password resets, software installs, and access requests.", mappedPillars: ["self-heal", "mod-proc"] },
                    { name: "Knowledge Management", description: "Using AI to suggest knowledge articles to users and agents.", mappedPillars: ["obs-ai"] },
                    { name: "User Communication & Escalation", description: "Automating status updates and intelligent escalation to appropriate teams.", mappedPillars: ["mod-proc", "defect-dens"] }
                ]
            }
        };

        const levelsData = [
            { 
                level: 0, 
                name: "Core", 
                color: "bg-slate-500",
                description: "Operations are entirely manual. Teams respond to issues only after they occur, with high levels of toil and inconsistent processes. There is little to no monitoring or automation.",
                details: "Manual, reactive, and high toil. Basic operations with no formal SRE practices.",
                analogy: "<strong>Firefighter:</strong> Reacts only when there’s a fire."
            },
            { 
                level: 1, 
                name: "Established", 
                color: "bg-purple-400",
                description: "Processes are documented with SOPs and runbooks. Basic monitoring is in place, and simple, rule-based automation (scripts, RPA) is used for repetitive, known tasks.",
                details: "Structured SOPs, RPAs, Rule-Based Automation, Insights Driven, Chatbot, GenAI.",
                analogy: "<strong>Tower-Controlled Takeoff:</strong> Structured SOPs, dashboards, and RPAs help lift off."
            },
            { 
                level: 2, 
                name: "Adaptive", 
                color: "bg-purple-500",
                description: "Automation becomes more sophisticated. Systems use anomaly detection to identify potential issues, triggering automated runbooks. The focus shifts to proactively preventing incidents.",
                details: "Agent-led systems. Agentic systems support triage, reviews, and knowledge evolution.",
                analogy: "<strong>Autopilot Engaged:</strong> GenAI agents assist in-flight tasks like triage and fixes."
            },
            { 
                level: 3, 
                name: "Autonomous", 
                color: "bg-purple-600",
                description: "AIOps and machine learning predict potential issues before they impact services. Self-healing capabilities are widespread, automatically resolving predicted problems without human intervention.",
                details: "Emergent, reflexive AI systems. Systems are self-healing, and agents enforce policies and react in real-time.",
                analogy: "<strong>AI Co-Pilot:</strong> Systems navigate intelligently with agents."
            },
            { 
                level: 4, 
                name: "Disruptive", 
                color: "bg-indigo-700",
                description: "Operations are managed by autonomous AI agents that can reason, learn, and adapt. They resolve complex, unknown issues and also optimize, secure, and re-architect systems to meet business outcomes.",
                details: "Agentic collaboration (collective AI). AI redefines, redesigns, and optimizes its own mission.",
                analogy: "<strong>Galactic Explorer:</strong> AI reshapes its own mission, charts new paths, and avoids turbulence."
            }
        ];
        
        const matrixData = {
            "fin-man": ["No FinOps", "Partial FinOps", "FinOps", "Full Stack FinOps", "Revenue Based FinOps"],
            "sec-pos": ["No SPM", "Partial SPM", "SPM", "Full Stack SPM", "Dynamic App Security"],
            "mod-proc": ["Waterfall", "Agile", "SRE", "Platform Engineering", "Agentic SRE"],
            "defect-dens": ["Reactive Problem Mgmt", "Proactive Problem Mgmt", "Predictive Problem Mgmt", "Cognitive Problem Mgmt", "Self-Healing Systems"],
            "self-heal": ["Manual Triage", "Automated Runbooks", "Event Correlation", "Self-Healing Scripts", "AIOps Driven Resolution"],
            "change-rel": ["Manual Changes", "Automated Patching", "Change Risk Prediction", "Blue/Green Releases", "Dynamic Workload Mgmt"],
            "devops": ["No CI/CD", "CI", "CI/CD", "DevSecOps", "AIOps in CI/CD"],
            "obs-ai": ["Basic Monitoring", "Centralized Logging", "Observability (L,M,T)", "AIOps", "Predictive Analytics"]
        };
        
        const steps = [
            { id: 'home', name: 'Home' },
            { id: 'summary', name: 'Executive Summary' },
            { id: 'responder-details', name: 'Responder Details' },
            { id: 'pillars', name: 'Core Pillars' },
            { id: 'levels', name: 'Maturity Levels' },
            { id: 'selection', name: 'Tower Selection' },
            { id: 'calculator', name: 'Maturity Assessment' },
            { id: 'assessment', name: 'Maturity Report' },
        ];
        let currentStepIndex = 0;

        let towerGroupAssessments = {};
        let towerPillarScores = {};
        let selectedTowers = []; // Start with no towers selected
        let chartInstances = [];
        let towerAssessmentStatus = {};
        let currentlySelectedTower = null;


        // --- INITIALIZATION ---
        function init() {
            populatePillars();
            populateLevels();
            populateMatrix();
            populateStepIndicator();
            initializeDataStores();
            populateTowerSelection();
            renderSummarySliders();
            attachEventListeners();
            navigateToStep(0);
        }

        function initializeDataStores() {
            allTowers.forEach(tower => {
                towerAssessmentStatus[tower] = false;
                towerGroupAssessments[tower] = {};
                towerPillarScores[tower] = {};
                if (towerCatalogData[tower] && towerCatalogData[tower].groups) {
                     towerCatalogData[tower].groups.forEach(group => {
                        towerGroupAssessments[tower][group.name] = 0; // Default to level 0
                    });
                }
                pillarsData.forEach(pillar => {
                    towerPillarScores[tower][pillar.id] = 0;
                });
            });
        }
        
        function populatePillars() {
            const pillarsContainer = document.querySelector('#pillars .grid');
            pillarsContainer.innerHTML = '';
            pillarsData.forEach(pillar => {
                const card = document.createElement('div');
                card.className = 'pillar-card bg-slate-50 border border-slate-200 rounded-xl p-6 flex flex-col h-full';
                card.innerHTML = `
                    <div class="flex items-start gap-4">
                         <div>
                             <h3 class="text-lg font-semibold text-slate-800">${pillar.name}</h3>
                             <span class="text-sm font-medium text-slate-500">Weight: ${pillar.weight}%</span>
                             <p class="text-sm text-slate-600 mt-2">${pillar.definition}</p>
                         </div>
                    </div>
                `;
                pillarsContainer.appendChild(card);
            });
        }
        
        function populateLevels() {
            const levelsContainer = document.querySelector('#levels .relative');
            levelsContainer.innerHTML = '';
            levelsData.forEach(level => {
                 const item = document.createElement('div');
                 item.className = 'level-item relative pb-10';
                 item.innerHTML = `
                    <div class="level-circle absolute left-0 top-0 flex items-center justify-center w-10 h-10 rounded-full ${level.color}">
                        <span class="text-white font-bold text-lg">${level.level}</span>
                    </div>
                    <div class="ml-16 bg-slate-50 border border-slate-200 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-slate-800 -mt-1">${level.name}</h3>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 text-sm text-slate-600 leading-6">
                            <div>
                                <h4 class="font-semibold text-slate-800 mb-2">Description</h4>
                                <p>${level.description}</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-slate-800 mb-2">Details</h4>
                                <p>${level.details}</p>
                            </div>
                            <div>
                                <h4 class="font-semibold text-slate-800 mb-2">Analogy</h4>
                                <p class="italic">${level.analogy}</p>
                            </div>
                        </div>
                    </div>
                `;
                levelsContainer.appendChild(item);
            });
        }

        function populateMatrix() {
            const summaryContainer = document.getElementById('summary');
            let headerHtml = `
                <div class="p-3 text-left font-bold text-slate-900 bg-slate-200 sticky left-0 z-10">Pillar</div>
                ${levelsData.map(level => `
                    <div class="p-3 text-center font-bold text-white ${level.color}">
                        <span class="block text-lg">${level.level}</span>
                        <span class="block text-xs sm:text-sm">${level.name}</span>
                    </div>
                `).join('')}
            `;
            let dataHtml = pillarsData.map(pillar => {
                let pillarRow = `<div class="p-3 font-semibold text-slate-800 bg-slate-100 flex items-center sticky left-0 z-10">${pillar.name}</div>`;
                let cellRows = matrixData[pillar.id].map(text => `
                    <div class="p-3 text-center text-slate-700 bg-white flex items-center justify-center">
                        ${text}
                    </div>
                `).join('');
                return pillarRow + cellRows;
            }).join('');

            const gridHtml = `
                <div class="mt-12">
                    <h3 class="text-2xl font-semibold text-slate-800 mb-6 text-center">Framework Matrix At-a-Glance</h3>
                    <div class="overflow-x-auto rounded-lg border border-slate-300 shadow-md">
                        <div class="grid grid-cols-[minmax(180px,_1.5fr)_repeat(5,_minmax(140px,_1fr))] bg-slate-300 text-xs sm:text-sm" style="gap: 1px;">
                            ${headerHtml}
                            ${dataHtml}
                        </div>
                    </div>
                </div>
            `;
            summaryContainer.insertAdjacentHTML('beforeend', gridHtml);
        }
        
        function populateStepIndicator() {
            const indicator = document.getElementById('step-indicator');
            indicator.innerHTML = '';
            steps.forEach((step, index) => {
                const isLast = index === steps.length - 1;
                const item = document.createElement('div');
                item.className = 'step-item flex items-center';
                item.dataset.stepIndex = index;

                // Make the container flexible and responsive
                item.style.flexShrink = '1';
                item.style.minWidth = '0';
                if (!isLast) {
                    item.style.flexGrow = '1';
                }

                item.innerHTML = `
                    <div class="step-circle flex-shrink-0 flex items-center justify-center w-8 h-8 rounded-full border-2 border-gray-300 bg-white text-gray-500 font-bold">${index + 1}</div>
                    <div class="step-text ml-2 text-sm text-gray-500 hidden md:block truncate">${step.name}</div>
                    ${!isLast ? '<div class="flex-1 border-t-2 border-gray-300 mx-2 md:mx-4"></div>' : ''}
                `;
                indicator.appendChild(item);
            });
        }


        function setResponderDefaults() {
            document.getElementById('assessment-date').value = new Date().toISOString().split('T')[0];
        }

        function populateTowerSelection() {
            const grid = document.getElementById('tower-selection-grid');
            grid.innerHTML = '';
            allTowers.forEach(tower => {
                const div = document.createElement('div');
                div.className = 'relative flex items-start';
                div.innerHTML = `
                    <div class="flex h-6 items-center">
                        <input id="tower-select-${tower.replace(/\s+/g, '-')}" name="tower-selection" type="checkbox" value="${tower}" class="h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-600">
                    </div>
                    <div class="ml-3 text-sm leading-6">
                        <label for="tower-select-${tower.replace(/\s+/g, '-')}" class="font-medium text-gray-900">${tower}</label>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function renderTowerTabs() {
            const container = document.getElementById('tower-assessment-list-container');
            container.innerHTML = '';
            const tabContainer = document.createElement('div');
            tabContainer.className = 'flex flex-wrap gap-2';
            
            if (selectedTowers.length === 0) {
                 container.innerHTML = '<p class="text-center text-gray-500">No towers were selected. Please go back to the "Tower Selection" step.</p>';
                 return;
            }

            selectedTowers.forEach(towerName => {
                const isActive = towerName === currentlySelectedTower;
                const isCompleted = towerAssessmentStatus[towerName];

                const button = document.createElement('button');
                button.textContent = towerName;
                button.dataset.tower = towerName;
                button.className = `flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-md transition-colors ${
                    isActive 
                        ? 'bg-purple-600 text-white' 
                        : 'bg-slate-100 text-slate-700 hover:bg-slate-200'
                }`;
                
                const statusIndicator = document.createElement('span');
                statusIndicator.className = `w-3 h-3 rounded-full ${isCompleted ? 'bg-green-400' : 'bg-slate-400'}`;
                statusIndicator.title = isCompleted ? 'Completed' : 'Pending';

                button.prepend(statusIndicator);
                tabContainer.appendChild(button);
            });
            container.appendChild(tabContainer);
        }

        function selectTowerForAssessment(towerName) {
            currentlySelectedTower = towerName;
            towerAssessmentStatus[towerName] = true; // Mark as reviewed/clicked
            renderTowerTabs(); // Re-render to show active state and updated status
            renderCatalogAssessmentUI(towerName);
            updateSummary(towerName);
        }


        function renderCatalogAssessmentUI(towerName) {
            const questionsContainer = document.getElementById('assessment-questions');
            if (!towerName) {
                questionsContainer.innerHTML = '<p class="text-center text-gray-500">Please select a tower from the list above to begin.</p>';
                return;
            }
            questionsContainer.innerHTML = '';
            const towerData = towerCatalogData[towerName];

            if (!towerData || !towerData.groups) {
                questionsContainer.innerHTML = `<p>No catalog groups defined for ${towerName}.</p>`;
                return;
            }

            towerData.groups.forEach(group => {
                const details = document.createElement('details');
                details.className = 'bg-white border rounded-lg overflow-hidden';
                details.open = true;

                const summary = document.createElement('summary');
                summary.className = 'p-4 font-semibold text-lg bg-slate-50 flex justify-between items-center cursor-pointer';
                summary.textContent = group.name;
                details.appendChild(summary);

                const groupContent = document.createElement('div');
                groupContent.className = 'p-4 space-y-4';
                groupContent.innerHTML = `<p class="text-sm text-gray-600 mb-4">${group.description}</p>`;
                
                const fieldset = document.createElement('fieldset');
                fieldset.innerHTML = `
                    <legend class="sr-only">Maturity level for ${group.name}</legend>
                    <div class="flex flex-wrap gap-x-6 gap-y-3">
                        ${levelsData.map(level => `
                            <div class="flex items-center">
                                <input id="${towerName}-${group.name.replace(/[^a-zA-Z0-9]/g, "")}-${level.level}" name="${group.name}" type="radio" value="${level.level}" class="h-4 w-4 text-purple-600 border-gray-300 focus:ring-purple-500">
                                <label for="${towerName}-${group.name.replace(/[^a-zA-Z0-9]/g, "")}-${level.level}" class="ml-2 block text-sm font-medium text-gray-700">${level.level} - ${level.name}</label>
                            </div>
                        `).join('')}
                    </div>
                `;
                groupContent.appendChild(fieldset);
                details.appendChild(groupContent);
                questionsContainer.appendChild(details);
            });
            loadGroupAssessmentsForTower(towerName);
        }
        
        function renderSummarySliders() {
            const slidersContainer = document.getElementById('summary-sliders');
            slidersContainer.innerHTML = '';
            pillarsData.forEach(pillar => {
                const sliderGroup = document.createElement('div');
                sliderGroup.innerHTML = `
                     <div>
                        <label for="summary-slider-${pillar.id}" class="flex justify-between items-center text-sm font-medium text-gray-700 mb-1">
                            <span>${pillar.name}</span>
                            <span id="summary-value-${pillar.id}" class="font-bold text-purple-600 text-lg">0</span>
                        </label>
                        <input type="range" id="summary-slider-${pillar.id}" name="summary-slider-${pillar.id}" min="0" max="4" value="0" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none" disabled>
                    </div>
                `;
                slidersContainer.appendChild(sliderGroup);
            });
        }
        
        function attachEventListeners() {
            document.getElementById('back-button').addEventListener('click', () => navigateToStep(currentStepIndex - 1));
            document.getElementById('next-button').addEventListener('click', handleNextClick);
            document.getElementById('begin-survey-button').addEventListener('click', () => navigateToStep(1));
            
            document.getElementById('select-all-towers').addEventListener('click', () => {
                document.querySelectorAll('input[name="tower-selection"]').forEach(cb => cb.checked = true);
            });

            document.getElementById('deselect-all-towers').addEventListener('click', () => {
                document.querySelectorAll('input[name="tower-selection"]').forEach(cb => cb.checked = false);
            });

            document.getElementById('cancel-submission-button').addEventListener('click', hideConfirmationModal);
            document.getElementById('confirm-submission-button').addEventListener('click', saveAndSubmitAssessment);
            document.getElementById('export-pdf-button').addEventListener('click', exportToPdf);
            document.getElementById('close-incomplete-modal-button').addEventListener('click', hideIncompleteModal);


            document.getElementById('tower-assessment-list-container').addEventListener('click', (e) => {
                 if(e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    const towerName = e.target.closest('button').dataset.tower;
                    selectTowerForAssessment(towerName);
                }
            });


            document.getElementById('assessment-questions').addEventListener('change', event => {
                if (event.target.type === 'radio') {
                    const groupName = event.target.name;
                    const level = parseInt(event.target.value);
                    towerGroupAssessments[currentlySelectedTower][groupName] = level;
                    // Note: Status is now set when a tower tab is clicked, not on radio change.
                    updateSummary(currentlySelectedTower);
                }
            });

            document.getElementById('step-indicator').addEventListener('click', (e) => {
                const stepItem = e.target.closest('.step-item');
                if (stepItem && stepItem.classList.contains('completed')) {
                    const index = parseInt(stepItem.dataset.stepIndex, 10);
                    navigateToStep(index);
                }
            });
        }

        // --- NAVIGATION LOGIC ---
        function navigateToStep(index) {
            if (index < 0 || index >= steps.length) return;
            currentStepIndex = index;

            // Hide all panes
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            // Show current pane
            document.getElementById(steps[index].id).classList.remove('hidden');

            const stepNav = document.getElementById('step-nav-container');
            const navButtons = document.getElementById('nav-buttons-container');
            if (index === 0) { // Home screen
                stepNav.classList.add('hidden');
                navButtons.classList.add('hidden');
            } else {
                stepNav.classList.remove('hidden');
                navButtons.classList.remove('hidden');
            }

            // Update step indicator
            const stepItems = document.querySelectorAll('.step-item');
            stepItems.forEach((item, i) => {
                item.classList.remove('active', 'completed');
                if (i < index) {
                    item.classList.add('completed');
                } else if (i === index) {
                    item.classList.add('active');
                }
            });

            // Update button states and text
            const backButton = document.getElementById('back-button');
            const nextButton = document.getElementById('next-button');
            backButton.style.display = index === 1 ? 'none' : 'inline-flex'; // No back button on first step after home
            nextButton.style.display = index === steps.length - 1 ? 'none' : 'inline-flex';

            if (steps[index].id === 'selection') {
                nextButton.textContent = 'Confirm Selection & Proceed';
            } else if (steps[index].id === 'calculator') {
                nextButton.textContent = 'Submit & View Report';
            } else {
                nextButton.textContent = 'Next';
            }
             if(steps[index].id === 'assessment'){
                updateDashboard();
            }
            if (steps[index].id === 'responder-details') {
                setResponderDefaults();
            }
        }
        
        function handleNextClick() {
            const currentStepId = steps[currentStepIndex].id;
            
            if (currentStepId === 'selection') {
                selectedTowers = Array.from(document.querySelectorAll('input[name="tower-selection"]:checked')).map(cb => cb.value);
                if(selectedTowers.length === 0){
                    alert("Please select at least one tower to proceed.");
                    return;
                }
                // Reset status for the new selection
                Object.keys(towerAssessmentStatus).forEach(k => towerAssessmentStatus[k] = false);
                renderTowerTabs();
                selectTowerForAssessment(selectedTowers[0]);
            } else if (currentStepId === 'calculator') {
                const pendingTowers = selectedTowers.filter(tower => !towerAssessmentStatus[tower]);
                
                if (pendingTowers.length > 0) {
                    showIncompleteModal(pendingTowers);
                    return; // Block submission
                }
                showConfirmationModal();
                return; // Don't navigate yet, wait for modal confirmation
            }
            
            navigateToStep(currentStepIndex + 1);
        }
        
        
        // --- MODAL AND SUBMISSION LOGIC ---
        function showIncompleteModal(pendingTowers) {
            const list = document.getElementById('pending-towers-list');
            list.innerHTML = ''; // Clear previous list
            pendingTowers.forEach(tower => {
                const li = document.createElement('li');
                li.textContent = tower;
                list.appendChild(li);
            });
            document.getElementById('incomplete-modal').classList.remove('hidden');
        }

        function hideIncompleteModal() {
            document.getElementById('incomplete-modal').classList.add('hidden');
        }

        function showConfirmationModal() {
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        function hideConfirmationModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
        }
        
        function saveAndSubmitAssessment() {
            hideConfirmationModal();

            // 1. Generate and download raw data EXCEL
            generateAndDownloadExcel();

            // 2. Trigger email client
            triggerEmail();

            // 3. Navigate to the final report page
            navigateToStep(currentStepIndex + 1);
        }

        function generateAndDownloadExcel() {
            // --- Sheet 1: Assessment Data ---
            const responderDetails = {
                "Engagement Name": document.getElementById('engagement-name').value,
                "Project Team": document.getElementById('project-team').value,
                "Delivery Lead": document.getElementById('delivery-lead').value,
                "Service Delivery Manager": document.getElementById('sdm').value,
                "Engagement MD": document.getElementById('engagement-md').value,
                "Date of Assessment": document.getElementById('assessment-date').value
            };

            const assessmentDataForSheet = [];
            selectedTowers.forEach(tower => {
                const towerData = towerCatalogData[tower];
                if (towerData && towerData.groups) {
                    towerData.groups.forEach(group => {
                        const level = towerGroupAssessments[tower][group.name] || 0;
                        (group.mappedPillars || []).forEach(pillarId => {
                            const pillar = pillarsData.find(p => p.id === pillarId);
                            if (pillar) {
                                assessmentDataForSheet.push({
                                    ...responderDetails,
                                    "Service Tower": tower,
                                    "Catalog Group": group.name,
                                    "Core Pillar": pillar.name,
                                    "Maturity Level": level,
                                    "Pillar Weight": pillar.weight
                                });
                            }
                        });
                    });
                }
            });

            const ws1 = XLSX.utils.json_to_sheet(assessmentDataForSheet, {header: [
                "Engagement Name", "Project Team", "Delivery Lead", "Service Delivery Manager",
                "Engagement MD", "Date of Assessment", "Service Tower", "Catalog Group", 
                "Core Pillar", "Maturity Level", "Pillar Weight"
            ]});
            
            // --- Create Workbook and Download ---
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws1, "Assessment Data");
            
            const engagementName = document.getElementById('engagement-name').value || 'Assessment';
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `${engagementName}-Raw-Data-${date}.xlsx`);
        }
        
        function triggerEmail() {
            const recipient = "jason.penalosa@accenture.com";
            const subject = "Automation Maturity Framework Survey";
            const body = `
Hello there!

Please find the attached raw data from the Automation Maturity Assessment.

This file contains the responder's details and their inputs for each selected service tower.

**IMPORTANT:** Please attach the Excel file that was just downloaded to your computer before sending this email.

Thank you.
            `;

            const mailtoLink = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }


        async function exportToPdf() {
            const engagementName = document.getElementById('engagement-name').value || 'Assessment';
            const date = new Date().toISOString().split('T')[0];
            
            // Create a container for the PDF content
            const pdfExportContainer = document.createElement('div');
            pdfExportContainer.style.padding = '2rem';

            // Clone and add the main header
            const headerClone = document.querySelector('header').cloneNode(true);
            headerClone.style.marginBottom = '2rem';
            pdfExportContainer.appendChild(headerClone);

            // Define the specific tabs to export for the results page
            const tabsToExport = ['responder-details', 'assessment'];

            for (const tabId of tabsToExport) {
                const contentClone = document.getElementById(tabId).cloneNode(true);
                
                // Add a page break before the main report content
                if (tabId === 'assessment') {
                    contentClone.style.pageBreakBefore = 'always';
                }

                // Convert charts to images for the report tab
                if (tabId === 'assessment') {
                    contentClone.querySelector('#export-pdf-button')?.remove();
                    const canvasElements = contentClone.querySelectorAll('canvas');
                    
                    // Match canvas elements to their chart instances to render them as images
                    // This ensures the charts appear correctly in the PDF
                    canvasElements.forEach(clonedCanvas => {
                         const originalCanvasId = clonedCanvas.id;
                         const chartInstance = chartInstances.find(c => c.canvas.id === originalCanvasId);
                         if (chartInstance) {
                            const img = document.createElement('img');
                            img.src = chartInstance.toBase64Image();
                            img.style.width = '100%';
                            img.style.height = 'auto';
                            img.style.marginTop = '1rem';
                            clonedCanvas.parentNode.replaceChild(img, clonedCanvas);
                         }
                    });
                }
                
                pdfExportContainer.appendChild(contentClone);
            }
            
            const opt = {
                margin: 0.5,
                filename: `${engagementName}-Maturity-Report-${date}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
                pagebreak: { mode: ['css', 'legacy'] }
            };

            html2pdf().set(opt).from(pdfExportContainer).save();
        }

        function loadGroupAssessmentsForTower(towerName) {
            const groupAssessments = towerGroupAssessments[towerName];
            if (!groupAssessments) return;
            Object.keys(groupAssessments).forEach(groupName => {
                const level = groupAssessments[groupName];
                const radio = document.querySelector(`#assessment-questions input[name="${groupName}"][value="${level}"]`);
                if (radio) radio.checked = true;
            });
        }

        function calculatePillarScores(towerName) {
            pillarsData.forEach(p => { towerPillarScores[towerName][p.id] = 0; });

            const groupScores = towerGroupAssessments[towerName];
            const pillarContributions = {};
            const towerData = towerCatalogData[towerName];
            
            if (!towerData || !towerData.groups) {
                return;
            }

            let totalRatedScore = 0;
            let ratedGroupsCount = towerData.groups.length; // Assume all groups are rated
            towerData.groups.forEach(group => {
                const score = groupScores[group.name] || 0;
                totalRatedScore += score;
            });
            const overallTowerAverage = ratedGroupsCount > 0 ? totalRatedScore / ratedGroupsCount : 0;

            pillarsData.forEach(p => { pillarContributions[p.id] = { total: 0, count: 0 }; });

            towerData.groups.forEach(group => {
                const groupScore = groupScores[group.name] || 0;
                if (group.mappedPillars) {
                    group.mappedPillars.forEach(pillarId => {
                        pillarContributions[pillarId].total += groupScore;
                        pillarContributions[pillarId].count += 1;
                    });
                }
            });

            pillarsData.forEach(pillar => {
                const contribution = pillarContributions[pillar.id];
                const avgScore = contribution.count > 0 
                    ? contribution.total / contribution.count 
                    : overallTowerAverage;
                towerPillarScores[towerName][pillar.id] = avgScore;
            });
        }


        function getWeightedScore(towerName) {
            calculatePillarScores(towerName);
            let totalWeightedScore = 0;
            const pillarScores = towerPillarScores[towerName];
            pillarsData.forEach(pillar => {
                const score = pillarScores[pillar.id] || 0;
                const weight = pillar.weight / 100;
                totalWeightedScore += score * weight;
            });
            return parseFloat(totalWeightedScore.toFixed(2));
        }

        function getLevelDetails(score) {
            let maturityLevel = '';
            let levelColor = '';
            if (score < 1.0) { maturityLevel = 'Core'; levelColor = 'bg-slate-200 text-slate-800'; }
            else if (score < 2.0) { maturityLevel = 'Established'; levelColor = 'bg-purple-100 text-purple-800'; }
            else if (score < 3.0) { maturityLevel = 'Adaptive'; levelColor = 'bg-purple-200 text-purple-900'; }
            else if (score < 4.0) { maturityLevel = 'Autonomous'; levelColor = 'bg-indigo-100 text-indigo-800'; }
            else { maturityLevel = 'Disruptive'; levelColor = 'bg-indigo-200 text-indigo-900'; }
            return { maturityLevel, levelColor };
        }
        
        function updateAll() {
            updateSummary(currentlySelectedTower);
            updateDashboard();
        }

        function updateSummary(towerName) {
            if (!towerName) {
                 document.getElementById('total-score').textContent = "---";
                 const levelDisplay = document.getElementById('maturity-level-display');
                 levelDisplay.textContent = "N/A";
                 levelDisplay.className = `inline-block text-xl font-semibold rounded-full px-5 py-1 bg-gray-200 text-gray-800`;
                 renderSummarySliders(); 
                return;
            }

            const totalWeightedScore = getWeightedScore(towerName);
            const pillarScores = towerPillarScores[towerName];
            
            pillarsData.forEach(pillar => {
                const score = pillarScores[pillar.id] || 0;
                const slider = document.getElementById(`summary-slider-${pillar.id}`);
                const valueDisplay = document.getElementById(`summary-value-${pillar.id}`);
                if(slider) slider.value = score;
                if(valueDisplay) valueDisplay.textContent = score.toFixed(2);
            });
            
            document.getElementById('total-score').textContent = totalWeightedScore;
            const levelDisplay = document.getElementById('maturity-level-display');
            const { maturityLevel, levelColor } = getLevelDetails(totalWeightedScore);
            levelDisplay.textContent = maturityLevel;
            levelDisplay.className = `inline-block text-xl font-semibold rounded-full px-5 py-1 ${levelColor}`;
        }
        
        function updateDashboard() {
             const grid = document.getElementById('dashboard-results-grid');
             grid.innerHTML = '';
             chartInstances.forEach(chart => chart.destroy());
             chartInstances = [];
             
             let overallTotalScore = 0;
             let assessedTowersCount = selectedTowers.length;
             
             if (assessedTowersCount === 0) {
                 grid.innerHTML = '<p class="text-center text-gray-500 col-span-full">No towers selected. Please make selections in the "Tower Selection" tab.</p>';
                 document.getElementById('overall-dashboard-score').textContent = '0.00';
                 const overallLevelDisplay = document.getElementById('overall-dashboard-level');
                 overallLevelDisplay.textContent = 'Core';
                 overallLevelDisplay.className = 'inline-block text-xl font-semibold bg-slate-200 text-slate-800 rounded-full px-5 py-1';
                 return;
             }

             selectedTowers.forEach(towerName => {
                 const score = getWeightedScore(towerName);
                 overallTotalScore += score;
                 const { maturityLevel, levelColor } = getLevelDetails(score);

                 const card = document.createElement('div');
                 card.className = 'p-4 border rounded-lg bg-slate-50 flex flex-col';
                 card.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold text-slate-800">${towerName}</h3>
                        <div class="flex items-baseline gap-4 my-2">
                             <p class="text-4xl font-bold text-purple-600">${score.toFixed(2)}</p>
                             <p class="inline-block text-md font-semibold rounded-full px-4 py-1 ${levelColor}">${maturityLevel}</p>
                        </div>
                        <div class="h-64 mt-4"><canvas id="chart-${towerName.replace(/\s+/g, '-')}"></canvas></div>
                    </div>
                 `;
                 grid.appendChild(card);
             });
             
             const averageScore = assessedTowersCount > 0 ? (overallTotalScore / assessedTowersCount) : 0;
             document.getElementById('overall-dashboard-score').textContent = averageScore.toFixed(2);
             const { maturityLevel: overallLevel, levelColor: overallColor } = getLevelDetails(averageScore);
             const overallLevelDisplay = document.getElementById('overall-dashboard-level');
             overallLevelDisplay.textContent = overallLevel;
             overallLevelDisplay.className = `inline-block text-xl font-semibold rounded-full px-5 py-1 ${overallColor}`;


             selectedTowers.forEach(towerName => {
                 const ctx = document.getElementById(`chart-${towerName.replace(/\s+/g, '-')}`).getContext('2d');
                 const chartData = pillarsData.map(p => towerPillarScores[towerName][p.id] || 0);
                 const newChart = new Chart(ctx, {
                     type: 'radar',
                     data: {
                         labels: pillarsData.map(p => p.name),
                         datasets: [{
                             label: 'Maturity Level',
                             data: chartData,
                             fill: true,
                             backgroundColor: 'rgba(147, 51, 234, 0.2)',
                             borderColor: 'rgb(147, 51, 234)',
                             pointBackgroundColor: 'rgb(147, 51, 234)',
                         }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         scales: { r: { suggestedMin: 0, suggestedMax: 4, ticks: { stepSize: 1 } } },
                         plugins: { legend: { display: false } }
                     }
                 });
                 chartInstances.push(newChart);
             });
        }

        init();
    });
</script>
</body>
</html>

